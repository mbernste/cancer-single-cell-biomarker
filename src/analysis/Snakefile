#

TUMORS = [
    'PJ016',
    'PJ018',
    'PJ048',
    'PJ030',
    'PJ025',
    'PJ035',
    'PJ017',
    'PJ032'
]

configfile: "config.json"

PAIRWISE_ALIGNED_OUTPUTS = [
        '{}/pairwise_integrations/PJ016_PJ018.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ016_PJ017.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ016_PJ025.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ016_PJ030.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ016_PJ032.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ016_PJ035.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ016_PJ048.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ017_PJ018.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ017_PJ025.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ017_PJ030.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ017_PJ032.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ017_PJ035.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ017_PJ048.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ018_PJ025.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ018_PJ030.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ018_PJ032.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ018_PJ035.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ018_PJ048.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ025_PJ030.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ025_PJ032.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ025_PJ035.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ025_PJ048.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ030_PJ032.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ030_PJ035.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ030_PJ048.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ032_PJ035.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ032_PJ048.h5'.format(config['output_dir']),
        '{}/pairwise_integrations/PJ035_PJ048.h5'.format(config['output_dir'])
]

PAIRWISE_ALIGNED_PHATE_OUTPUTS = [
        '{}/pairwise_integrations_PHATE/PJ016_PJ018_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ016_PJ017_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ016_PJ025_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ016_PJ030_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ016_PJ032_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ016_PJ035_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ016_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ017_PJ018_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ017_PJ025_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ017_PJ030_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ017_PJ032_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ017_PJ035_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ017_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ018_PJ025_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ018_PJ030_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ018_PJ032_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ018_PJ035_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ018_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ025_PJ030_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ025_PJ032_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ025_PJ035_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ025_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ030_PJ032_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ030_PJ035_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ030_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ032_PJ035_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ032_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/pairwise_integrations_PHATE/PJ035_PJ048_aligned_PHATE_3.tsv'.format(config['output_dir'])
]

rule all:
    input:
        '{}/cluster_de_genes.json'.format(config['output_dir']), 
        '{}/gsea_binary_matrix.tsv'.format(config['output_dir']),
        expand(
            '{out}/{{tumor}}_PHATE_3.tsv'.format(
                out=config['output_dir']
            ),
            tumor=TUMORS
        ),
        expand(
            '{tmp}/{{tumor}}_clusters.res_0_8.tsv'.format(
                tmp=config['output_dir']
            ),
            tumor=TUMORS
        ),
        '{}/all_tumors_aligned_PHATE_3.tsv'.format(config['output_dir']),
        '{}/tumor_cluster_gene_expression.tsv'.format(config['output_dir']),
        PAIRWISE_ALIGNED_OUTPUTS,
        PAIRWISE_ALIGNED_PHATE_OUTPUTS        

rule cluster_tumors:
    output:
        '{}/cluster_de_genes.json'.format(config['output_dir']),
        expand(
            '{tmp}/{{tumor}}_clusters.res_0_8.tsv'.format(
                tmp=config['output_dir']
            ),
            tumor=TUMORS
        )
    run:
        shell(
            'python cluster_and_de.py -r {} -o {}'.format(
                config['louvain_resolution'],
                config['output_dir']
            )
        )

rule compute_expression_per_cluster:
    input:
        '{}/cluster_de_genes.json'.format(config['output_dir'])
    output:
        '{}/tumor_cluster_gene_expression.tsv'.format(config['output_dir'])
    run:
        shell(
            'python identify_clusters_expressing_each_genes.py {tmp} {{input}} -o {tmp}'.format(
                tmp=config['output_dir']
            )
        ) 

rule gsea_per_cluster:
    input:
        '{}/cluster_de_genes.json'.format(config['output_dir'])
    output:
        '{}/gsea_results.tsv'.format(config['output_dir'])        
    run:
        shell(
            'python gsea.py {{input}} -o {out}'.format(
                out=config['output_dir']
            )
        )


rule compute_binary_matrix:
    input:
        '{}/gsea_results.tsv'.format(config['output_dir'])
    output:
        '{}/gsea_binary_matrix.tsv'.format(config['output_dir'])
    run:
        shell(
            'python compute_cluster_tumor_gsea_binary_matrix.py {{input}} -o {tmp}'.format(
                tmp=config['output_dir']
            )
        )

# TODO CellAssign does not seem to provide correct cell types...
rule assign_cell_types:
    output:
        expand(
            '{out}/{{tumor}}_predicted_cell_types.tsv'.format(
                out=config['output_dir']
            ),
            tumor=TUMORS
        ),
        expand(
            '{out}/{{tumor}}_predicted_cell_type_probs.tsv'.format(
                out=config['output_dir']
            ),
            tumor=TUMORS
        )
    run:
        shell(
            'Rscript assign_cell_types.R {data} {tmp} {data}/cell_type_markers.json'.format(
                tmp=config['output_dir'],
                data=config['data_dir']
            )
        )

###########################################################
#   Tumor alignment
###########################################################

rule align_tumors:
    input:
        '{}/GSE103224.h5'.format(config['data_dir'])
    output:
        '{}/GSE103224_aligned.h5'.format(config['output_dir'])
    run:
        shell(
            'Rscript integration.R {input} {output}'
        )

rule cluster_aligned_tumors:
    input:
        '{}/GSE103224_aligned.h5'.format(config['output_dir'])
    output:
        '{}/all_tumors_cluster_de_genes_aligned.json'.format(config['output_dir']),
        '{}/all_tumors_clusters_aligned.tsv'.format(config['output_dir'])
    run:
        shell(
            'python cluster_and_de_aligned.py {tmp} -o {tmp}'.format(
                tmp=config['output_dir']
            )
        )

#############################################################
#   Pair-wise tumor alignment
#############################################################
rule align_tumors_pairwise:
    input:
        '{}/GSE103224.h5'.format(config['data_dir'])
    output:
        PAIRWISE_ALIGNED_OUTPUTS
    run:
        shell(
            'Rscript pairwise_integration.R {{input}} {tmp}/pairwise_integrations'.format(
                tmp=config['output_dir']
            )   
        )

rule run_phate_pairwise_aligned_tumors:
    input:
        PAIRWISE_ALIGNED_OUTPUTS
    output:
        PAIRWISE_ALIGNED_PHATE_OUTPUTS
    run:
        shell(
            'mkdir -p {}/pairwise_integrations_PHATE'.format(config['output_dir'])
        ),
        shell(
            'python run_phate_pairwise_tumors_aligned.py {tmp}/pairwise_integrations -n 3 -o {tmp}/pairwise_integrations_PHATE'.format(
                tmp=config['output_dir']
            )
        )


############################################################
#   Create dimensionality reduction plot of all tumors
############################################################
rule run_phate_all_tumors:
    output:
        '{}/all_tumors_PHATE.tsv'.format(config['output_dir'])
    run:
        shell(
            'python run_phate_all_tumors.py -o {}'.format(config['output_dir'])
        )

rule run_phate_3d_all_tumors:
    output:
        '{}/all_tumors_PHATE_3.tsv'.format(config['output_dir'])
    run:
        shell(
            'python run_phate_all_tumors.py -n 3 -o {}'.format(config['output_dir'])
        )

rule run_phate_3d_all_tumors_aligned:
    input:
        '{}/GSE103224_aligned.h5'.format(config['output_dir']),
        '{}/all_tumors_clusters_aligned.tsv'.format(config['output_dir'])
    output:    
        '{}/all_tumors_aligned_PHATE_3.tsv'.format(config['output_dir'])
    run:
        shell(
            'python run_phate_all_tumors_aligned.py -n 3 {tmp} {data}/tumor_metadata.json -o {tmp}'.format(
                tmp=config['output_dir'],
                data=config['data_dir']
            )
        )

rule run_umap_all_tumors:
    output:
        '{}/all_tumors_UMAP.tsv'.format(config['output_dir'])
    run:
        shell(
            'python run_umap_all_tumors.py -o {}'.format(config['output_dir'])
        )


###########################################################
#   Run dimensionality reduction for each tumor
###########################################################

rule run_phate_per_tumor:
    output:
        expand(
            '{out}/{{tumor}}_PHATE.tsv'.format(
                out=config['output_dir']
            ),
            tumor=TUMORS
        )
    run:
        shell(
            'python run_phate_per_tumor.py -o {}'.format(
                config['output_dir']
            )            
        )

rule run_phate_3d_per_tumor:
    output:
        expand(
            '{out}/{{tumor}}_PHATE_3.tsv'.format(
                out=config['output_dir']
            ),
            tumor=TUMORS
        )
    run:
        shell(
            'python run_phate_per_tumor.py -n 3 -o {}'.format(
                config['output_dir']
            )
        )

rule run_umap_per_tumor:
    output:
        expand(
            '{out}/{{tumor}}_UMAP.tsv'.format(
                out=config['output_dir']
            ),
            tumor=TUMORS
        )
    run:
        shell(
            'python run_umap_per_tumor.py -o {}'.format(
                config['output_dir']
            )      
        )

